"use strict";function makeDir(a,b){fs.stat(a,function(c,d){null!==c&&"ENOENT"===c.code?fs.mkdir(a,b(null,a)):void 0!==d&&d.isDirectory()===!1?fs.unlink(a,function(){fs.mkdir(a,b(new Error("path was a file"),a))}):b(null,a)})}function toJson(a,b,c){var d=b.length-1;b.forEach(function(b,e){void 0!==b._id&&fs.writeFileSync(a+b._id+".json",JSON.stringify(b),{encoding:"utf8"}),d===e&&c()})}function toBson(a,b,c){var d=b.length-1;b.forEach(function(b,e){void 0!==b._id&&fs.writeFileSync(a+b._id+".bson",BSON.serialize(b),{encoding:null}),d===e&&c()})}function allCollections(a,b,c,d){a.collections(function(a,e){if(null===a){var f=e.length-1;e.forEach(function(a,e){makeDir(b+a.collectionName+"/",function(b,g){a.find().toArray(function(a,b){null===a&&c(g,b,function(){f===e&&d()})})})})}})}function someCollections(a,b,c,d,e){var f=e.length-1;e.forEach(function(e,g){a.collection(e,function(a,e){null===a&&makeDir(b+e.collectionName+"/",function(a,b){e.find().toArray(function(a,e){null===a&&c(b,e,function(){f===g&&d()})})})})})}function wrapper(a){var b=toJson;"bson"===a.parser&&(BSON=require("bson").BSONPure.BSON,b=toBson);var c=allCollections;null!==a.collections&&(c=someCollections),client.connect(a.uri,function(d,e){makeDir(a.root+e.databaseName+"/",function(d,f){c(e,f,b,function(){e.close(),null!==a.callback&&a.callback()},a.collections)})})}function backup(a){var b=a||Object.create(null);if(!b.uri)throw new Error("missing uri options");if(!b.root)throw new Error("missing root options");var c={dir:__dirname,uri:String(b.uri),root:resolve(String(b.root))+"/",parser:String(b.parser||"json"),collections:Array.isArray(b.collections)?b.collections:null,callback:"function"==typeof b.callback?b.callback:null};return wrapper(c)}try{var fs=require("fs"),resolve=require("path").resolve,client=require("mongodb").MongoClient,BSON}catch(MODULE_NOT_FOUND){console.error(MODULE_NOT_FOUND),process.exit(1)}module.exports=backup;
